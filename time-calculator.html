<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™‚é–“è¨ˆç®—å™¨ | Widget å·¥å…·é›†</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="page-time">
    <div class="container">
        <div class="header">
            <h1>â° æ™‚é–“è¨ˆç®—å™¨</h1>
            <div class="subtitle">æ™‚é–“å·®è¨ˆç®—ã€å·¥æ™‚çµ±è¨ˆã€å€’æ•¸è¨ˆæ™‚ã€æ™‚å€è½‰æ›</div>
        </div>

        <div class="main-content">
            <!-- æ¨¡å¼é¸æ“‡ -->
            <div class="mode-selector">
                <button type="button" class="mode-btn active" onclick="switchMode('diff', this)">æ™‚é–“å·®</button>
                <button type="button" class="mode-btn" onclick="switchMode('work', this)">å·¥æ™‚</button>
                <button type="button" class="mode-btn" onclick="switchMode('countdown', this)">å€’æ•¸</button>
                <button type="button" class="mode-btn" onclick="switchMode('timezone', this)">æ™‚å€</button>
            </div>

            <!-- æ™‚é–“å·®è¨ˆç®— -->
            <div id="diffMode" class="calculator-mode active">
                <form id="diffForm">
                    <div class="form-group">
                        <label for="startDateTime">é–‹å§‹æ™‚é–“</label>
                        <input type="datetime-local" id="startDateTime" required>
                        <button type="button" class="now-btn" onclick="setCurrentTime('startDateTime')">ç¾åœ¨</button>
                    </div>

                    <div class="form-group">
                        <label for="endDateTime">çµæŸæ™‚é–“</label>
                        <input type="datetime-local" id="endDateTime" required>
                        <button type="button" class="now-btn" onclick="setCurrentTime('endDateTime')">ç¾åœ¨</button>
                    </div>

                    <div class="quick-actions">
                        <button type="button" class="quick-btn" onclick="setQuickDiff(1, 'years')">1å¹´å¾Œ</button>
                        <button type="button" class="quick-btn" onclick="setQuickDiff(1, 'months')">1æœˆå¾Œ</button>
                        <button type="button" class="quick-btn" onclick="setQuickDiff(7, 'days')">1é€±å¾Œ</button>
                        <button type="button" class="quick-btn" onclick="setQuickDiff(1, 'days')">1å¤©å¾Œ</button>
                    </div>

                    <button type="submit">è¨ˆç®—æ™‚é–“å·®</button>
                </form>

                <div id="diffResult" class="result">
                    <h3>â±ï¸ æ™‚é–“å·®çµæœ</h3>
                    <div class="result-value" id="diffValue"></div>
                </div>
            </div>

            <!-- å·¥æ™‚è¨ˆç®— -->
            <div id="workMode" class="calculator-mode">
                <form id="workForm">
                    <div class="form-group">
                        <label for="workDate">å·¥ä½œæ—¥æœŸ</label>
                        <input type="date" id="workDate" required>
                        <button type="button" class="now-btn" onclick="setToday('workDate')">ä»Šå¤©</button>
                    </div>

                    <div class="time-row">
                        <div class="form-group">
                            <label for="startTime">ä¸Šç­æ™‚é–“</label>
                            <input type="time" id="startTime" value="09:00" required>
                        </div>
                        <div class="form-group">
                            <label for="endTime">ä¸‹ç­æ™‚é–“</label>
                            <input type="time" id="endTime" value="18:00" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="breakMinutes">ä¼‘æ¯æ™‚é–“</label>
                        <select id="breakMinutes">
                            <option value="0">ç„¡</option>
                            <option value="30">30åˆ†é˜</option>
                            <option value="60" selected>1å°æ™‚</option>
                            <option value="90">1.5å°æ™‚</option>
                            <option value="120">2å°æ™‚</option>
                        </select>
                    </div>

                    <button type="submit">è¨ˆç®—å·¥æ™‚</button>
                </form>

                <div id="workResult" class="result">
                    <h3>ğŸ’¼ å·¥æ™‚çµæœ</h3>
                    <div class="result-value" id="workValue"></div>
                </div>
            </div>

            <!-- å€’æ•¸è¨ˆæ™‚ -->
            <div id="countdownMode" class="calculator-mode">
                <form id="countdownForm">
                    <div class="form-group">
                        <label for="targetDateTime">ç›®æ¨™æ™‚é–“</label>
                        <input type="datetime-local" id="targetDateTime" required>
                    </div>

                    <div class="form-group">
                        <label for="countdownLabel">å€’æ•¸åç¨±</label>
                        <input type="text" id="countdownLabel" placeholder="ä¾‹å¦‚ï¼šè€ƒè©¦ã€ç”Ÿæ—¥ã€å°ˆæ¡ˆæˆªæ­¢" maxlength="20">
                        <div class="unit">é¸å¡«ï¼Œæœ€å¤š20å­—</div>
                    </div>

                    <div class="quick-actions">
                        <button type="button" class="quick-btn" onclick="setQuickTarget('æ–°å¹´', getNextNewYear())">æ–°å¹´</button>
                        <button type="button" class="quick-btn" onclick="setQuickTarget('æ˜¥ç¯€', getNextSpringFestival())">æ˜¥ç¯€</button>
                        <button type="button" class="quick-btn" onclick="setQuickTarget('ä¸­ç§‹', getNextMidAutumn())">ä¸­ç§‹</button>
                        <button type="button" class="quick-btn" onclick="setCustomTarget()">è‡ªå®šç¾©</button>
                    </div>

                    <button type="submit">é–‹å§‹å€’æ•¸</button>
                </form>

                <div id="countdownResult" class="result">
                    <div id="countdownDisplay"></div>
                </div>
            </div>

            <!-- æ™‚å€è½‰æ› -->
            <div id="timezoneMode" class="calculator-mode">
                <form id="timezoneForm">
                    <div class="form-group">
                        <label for="sourceTime">æŒ‡å®šæ™‚é–“</label>
                        <input type="datetime-local" id="sourceTime" required>
                        <button type="button" class="now-btn" onclick="setCurrentTime('sourceTime')">ç¾åœ¨</button>
                    </div>

                    <div class="form-group">
                        <label for="sourceTimezone">ä¾†æºæ™‚å€</label>
                        <select id="sourceTimezone">
                            <option value="Asia/Taipei" selected>å°åŒ— (GMT+8)</option>
                            <option value="Asia/Tokyo">æ±äº¬ (GMT+9)</option>
                            <option value="Asia/Shanghai">ä¸Šæµ· (GMT+8)</option>
                            <option value="Asia/Hong_Kong">é¦™æ¸¯ (GMT+8)</option>
                            <option value="Asia/Singapore">æ–°åŠ å¡ (GMT+8)</option>
                            <option value="America/New_York">ç´ç´„ (GMT-5/-4)</option>
                            <option value="America/Los_Angeles">æ´›æ‰ç£¯ (GMT-8/-7)</option>
                            <option value="Europe/London">å€«æ•¦ (GMT+0/+1)</option>
                            <option value="Europe/Paris">å·´é» (GMT+1/+2)</option>
                        </select>
                    </div>

                    <button type="submit">è½‰æ›æ™‚å€</button>
                </form>

                <div id="timezoneResult" class="result">
                    <h3>ğŸŒ ä¸–ç•Œæ™‚å€</h3>
                    <div id="timezoneDisplay"></div>
                </div>
            </div>

            <div class="back-link">
                ğŸ”— <a href="index.html">è¿”å› Widget å·¥å…·é›†é¦–é </a>
            </div>
        </div>
    </div>

    <script>
        let countdownInterval = null;

        // HTML è½‰ç¾©å‡½æ•¸ - é˜²æ­¢ XSS æ”»æ“Š
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // æ¨¡å¼åˆ‡æ›
        function switchMode(mode, btn) {
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            document.querySelectorAll('.calculator-mode').forEach(div => div.classList.remove('active'));
            document.getElementById(mode + 'Mode').classList.add('active');

            // åœæ­¢å€’æ•¸è¨ˆæ™‚
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        // è¨­ç½®ç•¶å‰æ™‚é–“
        function setCurrentTime(elementId) {
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString().slice(0, 16);
            document.getElementById(elementId).value = localDateTime;
        }

        // è¨­ç½®ä»Šå¤©æ—¥æœŸ
        function setToday(elementId) {
            const today = new Date().toISOString().slice(0, 10);
            document.getElementById(elementId).value = today;
        }

        // å¿«é€Ÿè¨­å®šæ™‚é–“å·®
        function setQuickDiff(amount, unit) {
            const now = new Date();
            const future = new Date(now);
            
            switch(unit) {
                case 'years':
                    future.setFullYear(future.getFullYear() + amount);
                    break;
                case 'months':
                    future.setMonth(future.getMonth() + amount);
                    break;
                case 'days':
                    future.setDate(future.getDate() + amount);
                    break;
            }

            const nowLocal = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString().slice(0, 16);
            const futureLocal = new Date(future.getTime() - future.getTimezoneOffset() * 60000)
                .toISOString().slice(0, 16);

            document.getElementById('startDateTime').value = nowLocal;
            document.getElementById('endDateTime').value = futureLocal;
        }

        // è¡¨å–®äº‹ä»¶ç¶å®š
        document.getElementById('diffForm').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateTimeDiff();
        });

        document.getElementById('workForm').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateWorkHours();
        });

        document.getElementById('countdownForm').addEventListener('submit', function(e) {
            e.preventDefault();
            startCountdown();
        });

        document.getElementById('timezoneForm').addEventListener('submit', function(e) {
            e.preventDefault();
            convertTimezone();
        });

        // æ™‚é–“å·®è¨ˆç®—
        function calculateTimeDiff() {
            const start = new Date(document.getElementById('startDateTime').value);
            const end = new Date(document.getElementById('endDateTime').value);

            if (start >= end) {
                alert('çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“');
                return;
            }

            const diff = end.getTime() - start.getTime();
            const result = formatTimeDifference(diff);

            document.getElementById('diffValue').innerHTML = result;
            document.getElementById('diffResult').classList.add('show');
        }

        // å·¥æ™‚è¨ˆç®—
        function calculateWorkHours() {
            const date = document.getElementById('workDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const breakMinutes = parseInt(document.getElementById('breakMinutes').value);

            const start = new Date(date + 'T' + startTime);
            const end = new Date(date + 'T' + endTime);

            if (start >= end) {
                alert('ä¸‹ç­æ™‚é–“å¿…é ˆæ™šæ–¼ä¸Šç­æ™‚é–“');
                return;
            }

            const workMs = end.getTime() - start.getTime();
            const workMinutes = Math.floor(workMs / (1000 * 60)) - breakMinutes;
            const workHours = (workMinutes / 60).toFixed(1);

            const overtime = workMinutes > 8 * 60 ? ((workMinutes - 8 * 60) / 60).toFixed(1) : 0;

            let result = `<div style="text-align: center;">
                <div style="font-size: 1.2em; margin-bottom: 8px;">ç¸½å·¥æ™‚: <strong>${workHours} å°æ™‚</strong></div>
                <div style="color: #666; font-size: 0.9em;">
                    å·¥ä½œ: ${Math.floor(workMinutes/60)}å°æ™‚${workMinutes%60}åˆ†é˜<br>
                    ä¼‘æ¯: ${breakMinutes}åˆ†é˜
                </div>`;
            
            if (overtime > 0) {
                result += `<div style="color: #ff6b6b; margin-top: 8px; font-weight: 600;">
                    åŠ ç­: ${overtime} å°æ™‚
                </div>`;
            }
            
            result += '</div>';

            document.getElementById('workValue').innerHTML = result;
            document.getElementById('workResult').classList.add('show');
        }

        // å€’æ•¸è¨ˆæ™‚
        function startCountdown() {
            const target = new Date(document.getElementById('targetDateTime').value);
            const label = document.getElementById('countdownLabel').value || 'ç›®æ¨™æ™‚é–“';

            if (target <= new Date()) {
                alert('ç›®æ¨™æ™‚é–“å¿…é ˆæ˜¯æœªä¾†æ™‚é–“');
                return;
            }

            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            updateCountdown(target, label);
            countdownInterval = setInterval(() => updateCountdown(target, label), 1000);
            document.getElementById('countdownResult').classList.add('show');
        }

        // æ›´æ–°å€’æ•¸é¡¯ç¤º
        function updateCountdown(target, label) {
            const now = new Date();
            const diff = target.getTime() - now.getTime();

            if (diff <= 0) {
                clearInterval(countdownInterval);
                document.getElementById('countdownDisplay').innerHTML = `
                    <div class="countdown-display">
                        <div class="countdown-label">${escapeHtml(label)}</div>
                        <div class="countdown-time">ğŸ‰ æ™‚é–“åˆ°ï¼</div>
                    </div>`;
                return;
            }

            const result = formatTimeDifference(diff);
            document.getElementById('countdownDisplay').innerHTML = `
                <div class="countdown-display">
                    <div class="countdown-label">è·é›¢ ${escapeHtml(label)} é‚„æœ‰</div>
                    <div class="countdown-time">${result}</div>
                </div>`;
        }

        // æ™‚å€è½‰æ›
        function convertTimezone() {
            const sourceTime = new Date(document.getElementById('sourceTime').value);
            const sourceZone = document.getElementById('sourceTimezone').value;

            const timezones = [
                { zone: 'Asia/Taipei', name: 'å°åŒ—' },
                { zone: 'Asia/Tokyo', name: 'æ±äº¬' },
                { zone: 'Asia/Shanghai', name: 'ä¸Šæµ·' },
                { zone: 'Asia/Hong_Kong', name: 'é¦™æ¸¯' },
                { zone: 'America/New_York', name: 'ç´ç´„' },
                { zone: 'America/Los_Angeles', name: 'æ´›æ‰ç£¯' },
                { zone: 'Europe/London', name: 'å€«æ•¦' },
                { zone: 'Europe/Paris', name: 'å·´é»' }
            ];

            let html = '';
            timezones.forEach(tz => {
                try {
                    const time = new Intl.DateTimeFormat('zh-TW', {
                        timeZone: tz.zone,
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    }).format(sourceTime);

                    html += `
                        <div class="timezone-item">
                            <span class="timezone-city">${tz.name}</span>
                            <span class="timezone-time">${time}</span>
                        </div>`;
                } catch (e) {
                    html += `
                        <div class="timezone-item">
                            <span class="timezone-city">${tz.name}</span>
                            <span class="timezone-time">è¨ˆç®—éŒ¯èª¤</span>
                        </div>`;
                }
            });

            document.getElementById('timezoneDisplay').innerHTML = html;
            document.getElementById('timezoneResult').classList.add('show');
        }

        // æ ¼å¼åŒ–æ™‚é–“å·®
        function formatTimeDifference(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const years = Math.floor(days / 365);
            const months = Math.floor((days % 365) / 30);

            let result = '';
            if (years > 0) result += `${years}å¹´ `;
            if (months > 0) result += `${months}æœˆ `;
            if (days % 30 > 0) result += `${days % 30}å¤© `;
            if (hours % 24 > 0) result += `${hours % 24}å°æ™‚ `;
            if (minutes % 60 > 0) result += `${minutes % 60}åˆ†é˜`;

            return result || 'ä¸åˆ°1åˆ†é˜';
        }

        // å¿«é€Ÿç›®æ¨™è¨­å®šï¼ˆç°¡åŒ–ç‰ˆï¼‰
        function setQuickTarget(name, date) {
            const localDateTime = new Date(date.getTime() - date.getTimezoneOffset() * 60000)
                .toISOString().slice(0, 16);
            document.getElementById('targetDateTime').value = localDateTime;
            document.getElementById('countdownLabel').value = name;
        }

        function getNextNewYear() {
            const next = new Date();
            next.setFullYear(next.getFullYear() + 1, 0, 1);
            next.setHours(0, 0, 0, 0);
            return next;
        }

        function getNextSpringFestival() {
            const next = new Date();
            next.setFullYear(next.getFullYear() + 1, 1, 10); // ç°¡åŒ–ç‚º2æœˆ10æ—¥
            next.setHours(0, 0, 0, 0);
            return next;
        }

        function getNextMidAutumn() {
            const next = new Date();
            const year = next.getMonth() >= 8 ? next.getFullYear() + 1 : next.getFullYear();
            next.setFullYear(year, 8, 15); // ç°¡åŒ–ç‚º9æœˆ15æ—¥
            next.setHours(0, 0, 0, 0);
            return next;
        }

        function setCustomTarget() {
            // è¨­ç½®ä¸€é€±å¾Œä½œç‚ºç¯„ä¾‹
            const future = new Date();
            future.setDate(future.getDate() + 7);
            const localDateTime = new Date(future.getTime() - future.getTimezoneOffset() * 60000)
                .toISOString().slice(0, 16);
            document.getElementById('targetDateTime').value = localDateTime;
            document.getElementById('countdownLabel').value = '';
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setCurrentTime('startDateTime');
            setToday('workDate');
            setCurrentTime('sourceTime');
        });

        // é é¢å¸è¼‰æ™‚æ¸…ç†å®šæ™‚å™¨
        window.addEventListener('beforeunload', function() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        });

        // é é¢éš±è—æ™‚æš«åœå®šæ™‚å™¨ï¼ˆçœé›»ï¼‰
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        });
    </script>
</body>
</html>