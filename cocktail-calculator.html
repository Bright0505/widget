<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª¿é…’è¨ˆç®—å™¨ | Widget å·¥å…·é›†</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="page-cocktail">
    <div class="container">
        <h1>ğŸ¸ èª¿é…’è¨ˆç®—å™¨</h1>
        
        <div class="mode-selector">
            <button type="button" class="mode-btn active" onclick="switchMode('mixing', this)">èª¿é…’è¨ˆç®—</button>
            <button type="button" class="mode-btn" onclick="switchMode('bac', this)">è¡€æ¶²æ¿ƒåº¦</button>
        </div>

        <!-- èª¿é…’è¨ˆç®—æ¨¡å¼ -->
        <div id="mixingMode" class="calculator-mode active">
            <form id="mixingForm" aria-label="èª¿é…’è¨ˆç®—è¡¨å–®">
                <div class="form-group">
                    <label for="targetConcentration">ç›®æ¨™é…’ç²¾æ¿ƒåº¦</label>
                    <input
                        type="number"
                        id="targetConcentration"
                        step="0.1"
                        min="0"
                        max="100"
                        required
                        aria-label="ç›®æ¨™é…’ç²¾æ¿ƒåº¦"
                        aria-describedby="targetConcentrationHelp"
                        aria-invalid="false">
                    <div class="unit" id="targetConcentrationHelp">å–®ä½ï¼šç™¾åˆ†æ¯” (%) - ä¾‹å¦‚ï¼š9%</div>
                </div>

                <div class="form-group">
                    <label for="totalVolume">ç¸½æ¶²é«”é‡</label>
                    <input
                        type="number"
                        id="totalVolume"
                        step="0.1"
                        min="0"
                        required
                        aria-label="ç¸½æ¶²é«”é‡"
                        aria-describedby="totalVolumeHelp"
                        aria-invalid="false">
                    <div class="unit" id="totalVolumeHelp">å–®ä½ï¼šæ¯«å‡ (ml) - ä¾‹å¦‚ï¼š250ml</div>
                </div>

                <div class="form-group">
                    <label for="alcoholConcentration">åŸºé…’æ¿ƒåº¦</label>
                    <input
                        type="number"
                        id="alcoholConcentration"
                        step="0.1"
                        min="0"
                        max="100"
                        value="40"
                        required
                        aria-label="åŸºé…’æ¿ƒåº¦"
                        aria-describedby="alcoholConcentrationHelp"
                        aria-invalid="false">
                    <div class="unit" id="alcoholConcentrationHelp">å–®ä½ï¼šç™¾åˆ†æ¯” (%) - ä¾‹å¦‚ï¼š40% ä¼ç‰¹åŠ </div>
                </div>

                <div id="liquidInputs">
                    <div class="liquid-input-group">
                        <div class="form-group">
                            <label for="liquidConcentration1">è¼”æ–™æ¿ƒåº¦</label>
                            <input type="number" id="liquidConcentration1" step="0.1" min="0" max="100" placeholder="è¼”æ–™é…’ç²¾æ¿ƒåº¦">
                            <div class="unit">å–®ä½ï¼šç™¾åˆ†æ¯” (%) - å¯é¸</div>
                        </div>
                        <div class="form-group">
                            <label for="liquidVolume1">è¼”æ–™å®¹é‡</label>
                            <input type="number" id="liquidVolume1" step="0.1" min="0" placeholder="è¼”æ–™æ¶²é«”å®¹é‡">
                            <div class="unit">å–®ä½ï¼šæ¯«å‡ (ml) - å¯é¸</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <button type="button" id="addLiquidBtn" onclick="addLiquidInput()">â• æ–°å¢è¼”æ–™</button>
                </div>

                <button type="submit" aria-label="è¨ˆç®—èª¿é…’æ‰€éœ€é…’ç²¾ç”¨é‡">ğŸ¸ è¨ˆç®—éœ€è¦å¤šå°‘é…’ç²¾</button>
            </form>

            <div id="mixingResult" class="result" role="region" aria-live="polite" aria-label="è¨ˆç®—çµæœ">
                <h3>ğŸ¹ èª¿é…’é…æ–¹</h3>
                <div id="mixingCalculation"></div>
            </div>
        </div>

        <!-- è¡€æ¶²æ¿ƒåº¦è¨ˆç®—æ¨¡å¼ -->
        <div id="bacMode" class="calculator-mode">
            <form id="bacForm" aria-label="è¡€æ¶²é…’ç²¾æ¿ƒåº¦è¨ˆç®—è¡¨å–®">
                <div class="form-group">
                    <label for="alcoholVolume">é…’ç²¾é£²æ–™å®¹é‡</label>
                    <input type="number" id="alcoholVolume" step="0.1" min="0" required>
                    <div class="unit">å–®ä½ï¼šæ¯«å‡ (ml)</div>
                </div>

                <div class="form-group">
                    <label for="alcoholPercentage">é…’ç²¾æ¿ƒåº¦</label>
                    <input type="number" id="alcoholPercentage" step="0.1" min="0" max="100" required>
                    <div class="unit">å–®ä½ï¼šç™¾åˆ†æ¯” (%)</div>
                </div>

                <div class="form-group">
                    <label for="bodyWeight">é«”é‡</label>
                    <input type="number" id="bodyWeight" step="0.1" min="0" required>
                    <div class="unit">å–®ä½ï¼šå…¬æ–¤ (kg)</div>
                </div>

                <div class="form-group">
                    <label for="gender">æ€§åˆ¥</label>
                    <select id="gender">
                        <option value="male">ç”·æ€§</option>
                        <option value="female">å¥³æ€§</option>
                    </select>
                </div>

                <button type="submit">è¨ˆç®—è¡€æ¶²é…’ç²¾æ¿ƒåº¦</button>
            </form>

            <div id="bacResult" class="result">
                <h3>è¡€æ¶²é…’ç²¾æ¿ƒåº¦ (BAC)</h3>
                <div class="bac-value" id="bacValue">0.00%</div>
                <div id="statusMessage"></div>
            </div>
        </div>

        <div class="note">
            âš ï¸ æ­¤è¨ˆç®—å™¨åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›é…’ç²¾æ¿ƒåº¦å—å¤šç¨®å› ç´ å½±éŸ¿ã€‚è«‹å‹¿é…’é§•ï¼Œçæ„›ç”Ÿå‘½ã€‚
        </div>

        <div class="back-link">
            ğŸ”— <a href="index.html">è¿”å› Widget å·¥å…·é›†é¦–é </a>
        </div>
    </div>

    <script>
        // æ¨¡å¼åˆ‡æ›
        function switchMode(mode, btn) {
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // æ›´æ–°é¡¯ç¤ºæ¨¡å¼
            document.querySelectorAll('.calculator-mode').forEach(div => div.classList.remove('active'));
            if (mode === 'mixing') {
                document.getElementById('mixingMode').classList.add('active');
            } else {
                document.getElementById('bacMode').classList.add('active');
            }
        }

        // èª¿é…è¨ˆç®—è¡¨å–®äº‹ä»¶
        document.getElementById('mixingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateMixing();
        });

        // è¡€æ¶²æ¿ƒåº¦è¨ˆç®—è¡¨å–®äº‹ä»¶
        document.getElementById('bacForm').addEventListener('submit', function(e) {
            e.preventDefault();
            calculateBAC();
        });

        // èª¿é…’è¨ˆç®—åŠŸèƒ½
        let liquidInputCounter = 1;

        // å‹•æ…‹å¢åŠ è¼”æ–™è¼¸å…¥æ¡†
        function addLiquidInput() {
            liquidInputCounter++;
            const liquidInputs = document.getElementById('liquidInputs');
            const newInputGroup = document.createElement('div');
            newInputGroup.classList.add('liquid-input-group');
            newInputGroup.innerHTML = `
                <div class="form-group">
                    <label for="liquidConcentration${liquidInputCounter}">è¼”æ–™æ¿ƒåº¦</label>
                    <input type="number" id="liquidConcentration${liquidInputCounter}" step="0.1" min="0" max="100" placeholder="è¼”æ–™é…’ç²¾æ¿ƒåº¦">
                    <div class="unit">å–®ä½ï¼šç™¾åˆ†æ¯” (%) - å¯é¸</div>
                </div>
                <div class="form-group">
                    <label for="liquidVolume${liquidInputCounter}">è¼”æ–™å®¹é‡</label>
                    <input type="number" id="liquidVolume${liquidInputCounter}" step="0.1" min="0" placeholder="è¼”æ–™æ¶²é«”å®¹é‡">
                    <div class="unit">å–®ä½ï¼šæ¯«å‡ (ml) - å¯é¸</div>
                </div>
                <button type="button" onclick="this.closest('.liquid-input-group').remove()">â– ç§»é™¤</button>
            `;
            liquidInputs.appendChild(newInputGroup);
        }

        // æ™ºèƒ½å››æ¨äº”å…¥ - å„ªå…ˆé¡¯ç¤ºä»¥ 0 æˆ– 5 çµå°¾çš„æ•´æ•¸
        function smartRound(value) {
            const rounded = Math.round(value);
            const rounded5 = Math.round(value / 5) * 5;
            const rounded10 = Math.round(value / 10) * 10;

            if (Math.abs(value - rounded10) / value <= 0.05) {
                return rounded10;
            } else if (Math.abs(value - rounded5) / value <= 0.03) {
                return rounded5;
            } else {
                return rounded;
            }
        }

        // æ”¶é›†è¼¸å…¥æ•¸æ“š
        function collectInputData() {
            const targetConcentration = parseFloat(document.getElementById('targetConcentration').value);
            const totalVolume = parseFloat(document.getElementById('totalVolume').value);
            const alcoholConcentration = parseFloat(document.getElementById('alcoholConcentration').value);

            const additionalLiquids = [];
            let additionalVolume = 0;

            for (let i = 1; i <= liquidInputCounter; i++) {
                const concentrationInput = document.getElementById(`liquidConcentration${i}`);
                const volumeInput = document.getElementById(`liquidVolume${i}`);

                if (concentrationInput && volumeInput) {
                    const liquidConcentration = parseFloat(concentrationInput.value) || 0;
                    const liquidVolume = parseFloat(volumeInput.value) || 0;

                    if (liquidVolume > 0) {
                        additionalLiquids.push({
                            concentration: liquidConcentration,
                            volume: liquidVolume
                        });
                        additionalVolume += liquidVolume;
                    }
                }
            }

            return {
                targetConcentration,
                totalVolume,
                alcoholConcentration,
                additionalLiquids,
                additionalVolume
            };
        }

        // é¡¯ç¤ºå‹å–„çš„éŒ¯èª¤è¨Šæ¯
        function showError(message, fieldId) {
            alert(`âŒ ${message}`);
            if (fieldId) {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.focus();
                    field.setAttribute('aria-invalid', 'true');
                    setTimeout(() => field.setAttribute('aria-invalid', 'false'), 3000);
                }
            }
        }

        // é©—è­‰è¼¸å…¥æ•¸æ“š
        function validateInputs(data) {
            const { targetConcentration, totalVolume, alcoholConcentration, additionalVolume } = data;

            if (isNaN(targetConcentration) || isNaN(totalVolume) || isNaN(alcoholConcentration)) {
                showError('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                return false;
            }

            if (totalVolume <= 0) {
                showError('ç¸½æ¶²é«”é‡å¿…é ˆå¤§æ–¼ 0', 'totalVolume');
                return false;
            }

            if (targetConcentration <= 0) {
                showError('ç›®æ¨™æ¿ƒåº¦å¿…é ˆå¤§æ–¼ 0', 'targetConcentration');
                return false;
            }

            if (targetConcentration > alcoholConcentration) {
                showError(`ç›®æ¨™æ¿ƒåº¦ (${targetConcentration}%) ä¸èƒ½é«˜æ–¼åŸºé…’æ¿ƒåº¦ (${alcoholConcentration}%)`, 'targetConcentration');
                return false;
            }

            const availableVolume = totalVolume - additionalVolume;
            if (availableVolume <= 0) {
                showError(`è¼”æ–™å®¹é‡ (${additionalVolume}ml) ä¸èƒ½è¶…éç¸½æ¶²é«”é‡ (${totalVolume}ml)`);
                return false;
            }

            return true;
        }

        // è¨ˆç®—èª¿é…’çµæœ
        function performCalculation(data) {
            const { targetConcentration, totalVolume, alcoholConcentration, additionalLiquids, additionalVolume } = data;
            const availableVolume = totalVolume - additionalVolume;

            const alcoholVolumeRaw = (targetConcentration * availableVolume) / alcoholConcentration;
            const alcoholVolume = smartRound(alcoholVolumeRaw);

            // é©—è­‰è¨ˆç®—çµæœ
            if (alcoholVolume > totalVolume) {
                showError(`ç„¡æ³•é”æˆç›®æ¨™æ¿ƒåº¦ï¼Œéœ€è¦ ${alcoholVolume}ml é…’ç²¾è¶…éç¸½å®¹é‡ ${totalVolume}ml`);
                return null;
            }

            const nonAlcoholVolume = totalVolume - alcoholVolume - additionalVolume;
            if (alcoholVolume < 0 || nonAlcoholVolume < 0) {
                showError('è¨ˆç®—çµæœç„¡æ•ˆï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ•¸å€¼');
                return null;
            }

            // è¨ˆç®—å¯¦éš›æ¿ƒåº¦
            const actualConcentration = (alcoholVolume * alcoholConcentration) / totalVolume;

            return {
                alcoholVolume,
                alcoholVolumeRaw,
                nonAlcoholVolume,
                actualConcentration
            };
        }

        // ç”Ÿæˆçµæœ HTML
        function generateResultHTML(data, result) {
            const { targetConcentration, totalVolume, alcoholConcentration, additionalLiquids, additionalVolume } = data;
            const { alcoholVolume, alcoholVolumeRaw, actualConcentration } = result;

            const additionalLiquidDetails = additionalLiquids.map(liquid =>
                `${liquid.volume} ml ${liquid.concentration}% è¼”æ–™`
            ).join('ã€');

            return `
                <div class="cocktail-result-container">
                    <h4 class="cocktail-result-title">ğŸ¹ å®Œç¾èª¿é…’é…æ–¹</h4>

                    <!-- ä¸»è¦çµæœ - é…’ç²¾ç”¨é‡ -->
                    <div class="cocktail-alcohol-needed">
                        <div class="cocktail-alcohol-label">ğŸ¥ƒ éœ€è¦é…’ç²¾ (${alcoholConcentration}%)</div>
                        <div class="cocktail-alcohol-value">${alcoholVolume} ml</div>
                        <div class="cocktail-alcohol-ratio">ç´„ ${((alcoholVolume / totalVolume) * 100).toFixed(0)}% æ¯”ä¾‹</div>
                        ${Math.abs(alcoholVolumeRaw - alcoholVolume) > 0.5 ?
                            `<div class="cocktail-adjustment-note">
                                ğŸ’¡ ç‚ºä¾¿æ–¼æ¸¬é‡å·²èª¿æ•´ç‚º ${alcoholVolume}ml (åŸè¨ˆç®—å€¼: ${alcoholVolumeRaw.toFixed(1)}ml)
                            </div>` : ''
                        }
                    </div>

                    <!-- è©³ç´°é…æ–¹ -->
                    <div class="cocktail-recipe-grid">
                        <div class="cocktail-recipe-item">
                            <div class="cocktail-recipe-emoji">ğŸº</div>
                            <div class="cocktail-recipe-label">é…’ç²¾ (${alcoholConcentration}%)</div>
                            <div class="cocktail-recipe-value">${alcoholVolume} ml</div>
                        </div>
                        <div class="cocktail-recipe-item">
                            <div class="cocktail-recipe-emoji">ğŸ§Š</div>
                            <div class="cocktail-recipe-label">è¼”æ–™</div>
                            <div class="cocktail-recipe-value">${additionalVolume} ml</div>
                        </div>
                    </div>

                    <!-- è¼”æ–™è©³ç´°è³‡è¨Š -->
                    ${additionalLiquids.length > 0 ? `
                    <div class="cocktail-additional-details">
                        <div class="cocktail-additional-title">ğŸ¹ è¼”æ–™æ˜ç´°</div>
                        <div class="cocktail-additional-content">
                            ${additionalLiquidDetails}
                        </div>
                    </div>` : ''}

                    <!-- æœ€çµ‚çµæœå¡ç‰‡ -->
                    <div class="cocktail-final-result">
                        <div class="cocktail-final-title">ğŸ¯ èª¿é…’çµæœ</div>
                        <div class="cocktail-final-values">
                            ç¸½å®¹é‡: ${totalVolume} ml | å¯¦éš›æ¿ƒåº¦: ${actualConcentration.toFixed(1)}%
                            ${Math.abs(actualConcentration - targetConcentration) > 0.1 ?
                                ` (ç›®æ¨™: ${targetConcentration}%)` : ''
                            }
                        </div>
                        <div class="cocktail-final-divider">
                            <div class="cocktail-final-alcohol">
                                ç´”é…’ç²¾å«é‡: ${(alcoholVolume * alcoholConcentration / 100).toFixed(0)} ml
                            </div>
                        </div>
                    </div>

                    <!-- èª¿é…’æç¤º -->
                    <div class="cocktail-tips">
                        <div class="cocktail-tips-content">
                            ğŸ¸ <strong>èª¿é…’æŠ€å·§ï¼š</strong><br>
                            1. å…ˆåŠ å…¥ ${alcoholVolume}ml çš„ ${alcoholConcentration}% é…’ç²¾<br>
                            2. å†åŠ å…¥ ${additionalLiquids.map(l => `${l.volume}ml ${l.concentration}% è¼”æ–™`).join('ã€')}<br>
                            3. æ”ªæ‹Œå‡å‹»ï¼Œäº«å— ${actualConcentration.toFixed(1)}% çš„å®Œç¾èª¿é…’ï¼
                        </div>
                    </div>
                </div>
            `;
        }

        // ä¸»å‡½æ•¸ï¼šèª¿é…’è¨ˆç®—
        function calculateMixing() {
            // 1. æ”¶é›†è¼¸å…¥æ•¸æ“š
            const inputData = collectInputData();

            // 2. é©—è­‰è¼¸å…¥
            if (!validateInputs(inputData)) {
                return;
            }

            // 3. è¨ˆç®—çµæœ
            const calculationResult = performCalculation(inputData);
            if (!calculationResult) {
                return;
            }

            // 4. ç”Ÿæˆä¸¦é¡¯ç¤ºçµæœ
            const resultHTML = generateResultHTML(inputData, calculationResult);
            document.getElementById('mixingCalculation').innerHTML = resultHTML;
            document.getElementById('mixingResult').classList.add('show');
        }

        // è¡€æ¶²æ¿ƒåº¦è¨ˆç®—åŠŸèƒ½
        function calculateBAC() {
            const alcoholVolume = parseFloat(document.getElementById('alcoholVolume').value);
            const alcoholPercentage = parseFloat(document.getElementById('alcoholPercentage').value);
            const bodyWeight = parseFloat(document.getElementById('bodyWeight').value);
            const gender = document.getElementById('gender').value;

            if (!alcoholVolume || !alcoholPercentage || !bodyWeight) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…è¦æ¬„ä½');
                return;
            }

            // è¨ˆç®—ç´”é…’ç²¾é‡é‡ (å…‹)
            const pureAlcoholWeight = (alcoholVolume * alcoholPercentage / 100) * 0.789;

            // æ°´åˆ†åˆ†å¸ƒä¿‚æ•¸ (Widmark coefficient)
            const widmarkCoefficient = gender === 'male' ? 0.68 : 0.55;

            // è¨ˆç®— BAC (è¡€æ¶²é…’ç²¾æ¿ƒåº¦)
            const bac = (pureAlcoholWeight / (bodyWeight * widmarkCoefficient)) * 100;

            // é¡¯ç¤ºçµæœ
            document.getElementById('bacValue').textContent = bac.toFixed(3) + '%';
            
            const statusMessage = document.getElementById('statusMessage');
            let messageClass = '';
            let message = '';

            if (bac < 0.05) {
                messageClass = 'safe';
                message = 'âœ… è¡€æ¶²é…’ç²¾æ¿ƒåº¦è¼ƒä½ï¼Œä½†ä»å»ºè­°é¿å…é§•é§›';
            } else if (bac < 0.08) {
                messageClass = 'warning';
                message = 'âš ï¸ å·²é”æ³•å¾‹ç¦æ­¢é§•é§›æ¨™æº– (0.05%)ï¼Œçµ•å°ä¸å¯é§•é§›';
            } else if (bac < 0.25) {
                messageClass = 'danger';
                message = 'ğŸš¨ è¡€æ¶²é…’ç²¾æ¿ƒåº¦éé«˜ï¼Œå¯èƒ½å‡ºç¾åš´é‡é†‰é…’ç—‡ç‹€';
            } else {
                messageClass = 'danger';
                message = 'ğŸ†˜ è¡€æ¶²é…’ç²¾æ¿ƒåº¦æ¥µé«˜ï¼Œæœ‰ç”Ÿå‘½å±éšªï¼Œè«‹ç«‹å³å°±é†«';
            }

            statusMessage.className = messageClass;
            statusMessage.textContent = message;

            document.getElementById('bacResult').classList.add('show');
        }

        // æ·»åŠ è¼¸å…¥é©—è­‰
        document.getElementById('alcoholPercentage').addEventListener('input', function() {
            if (this.value > 100) this.value = 100;
        });

        document.getElementById('targetConcentration').addEventListener('input', function() {
            if (this.value > 100) this.value = 100;
        });

        document.getElementById('alcoholConcentration').addEventListener('input', function() {
            if (this.value > 100) this.value = 100;
        });
    </script>
</body>
</html>